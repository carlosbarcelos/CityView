<!DOCTYPE html>
<html>
	<head>
		<link href='http://fonts.googleapis.com/css?family=Open+Sans|Raleway' rel='stylesheet' type='text/css'>
    	<meta charset="utf-8">
    	<title>Heatmap Data Upload</title> 
    	<link rel="stylesheet" type="text/css" href="css/main_about.css">    	
    	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
		<link rel="stylesheet" media="screen" href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" />
		<link rel="stylesheet" media="all" href="https://d2sxfzw9cql5wy.cloudfront.net/assets/v2-prospect-f62c3e8107723d8291b7d8bef73ccc6122ea918e640399c78de2ddc3340abdf5.css" />
		<link rel="stylesheet" media="print" href="https://d39afr5wio5j08.cloudfront.net/assets/print-5a29a9c455566fcb04f2d8332508e186e7022c91b0d2775f86018f0404780d01.css" />
    	<script src="papaparse.min.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=visualization"></script>
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
		<link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
		<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
		<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
		<script src="./jquery-2.1.1.min.js"></script>
	<style>
		html, body, #map-canvas {
      	height: 100%;
      	margin: 0px;
      	padding: 0px;
			font-family: 'Raleway', sans-serif;
			z-index:1;
    	}
		#draggable {
			z-index:100; 
			background-color: rgba(200,200,255,.7); 
			width: 300px;
			padding: 20px;
			position:absolute;
			top:150px;
			left:120px;
			cursor: move;
			border: black 1px solid;
		}
		#radius-label, #opacity-label, #max-label {
			margin-top: 10px;
		}
		#radius-slider, #opacity-slider, #max-slider {
			width:250px;
			margin-top: 10px;
		}
		.project {
			font-size: 10pt;
			font-weight: bold;
			margin-bottom: 10px;	
		}
		#radius-slider .ui-slider-handle, 
		#opacity-slider .ui-slider-handle,
		#max-slider .ui-slider-handle {
			cursor:pointer;
		}
  </style>
	<script>
		var map, pointarray, heatmap;
		var csv = [];
    // http://stackoverflow.com/a/2901298/562440
		function numberWithCommas(x) {
				return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}
		function handleFileSelect(evt) {
			var file = evt.target.files[0];
			Papa.parse(file, {
				header: true,
				dynamicTyping: true,
				complete: function(results) {
					csv = [];
					if(results.meta.fields.indexOf("weight") == -1) {
						for(idx in results["data"]) {
							var row = results["data"][idx];
							csv.push(new google.maps.LatLng(row["lat"], row["lon"]))
						}
					} else {
						var max = results["data"][0]["weight"];
						for(idx in results["data"]) {
							var row = results["data"][idx];
							max = Math.max(max, row["weight"]);
							csv.push({
								location: new google.maps.LatLng(row["lat"], row["lon"]),
								weight: row["weight"]
							});
						}
						$("#max-label").html("max: "+numberWithCommas(max));
						$("#max-slider").slider("option","max",max);
						$("#max-slider").slider("option","value",max);
					}
					console.log(results);					
					loadHeatmap(csv);
				}
			});
		}
		function initialize() {
		  var mapOptions = {
			zoom: 11,
			center: new google.maps.LatLng(22.5431, 114.0579),
			mapTypeId: google.maps.MapTypeId.hybrid
		  };
		  map = new google.maps.Map(document.getElementById('map-canvas'),
			  mapOptions);	  
		}
		function loadHeatmap(csv) {
			var pointArray = new google.maps.MVCArray(csv);

			if(heatmap) heatmap.setMap(null);
			heatmap = new google.maps.visualization.HeatmapLayer({
				data: pointArray,
				radius: $("#radius-slider").slider("value"),
				opacity: $("#opacity-slider").slider("value")
			});
			heatmap.setMap(map);
		}
		$(document).ready(function(){
			$("#csv-file").change(handleFileSelect);
			google.maps.event.addDomListener(window, 'load', initialize);
			$(function() {
				$( "#draggable" ).draggable();
			});
			$(function() {
				$( "#radius-slider" ).slider({
					orientation: "horizontal",
					range: "min",
					min: 1,
					max: 100,
					value: 20,
					slide: function(event, ui) {
						$("#radius-label").html("radius: " + ui.value);
						if(heatmap == null) return;
						heatmap.set('radius', ui.value);
					}
				});

				$( "#opacity-slider" ).slider({
					orientation: "horizontal",
					range: "min",
					min: 0,
					max: 100,
					value: 50,
					slide: function(event, ui) {
						$("#opacity-label").html("opacity: " + ui.value/100);
						if(heatmap == null) return;
						heatmap.set('opacity', ui.value/100);
					}
				});
				$( "#max-slider" ).slider({
					orientation: "horizontal",
					range: "min",
					min: 0,
					max: 1,
					value: 0,
					slide: function(event, ui) {
						$("#max-label").html("max: " + numberWithCommas(ui.value));
						if(heatmap == null) return;
						heatmap.set('maxIntensity', ui.value);
					}
				});
			});
		});
	</script>
</head>
<body>
	<header class= tm-header>
      <div class="tm-container">
        <a href="index.html">
        <img src="Images/SURV_logo2.png" alt="logo" width="120" class="surv-logo">
		<a href="https://www.wpi.edu">
		<img src="Images/WPI_logo.png" alt="WPI logo" width="120" class="wpi-logo">
			
			
		<a href="https://www.nsf.gov">
		<img src="Images/nsf_logo.jpg" alt="NSF logo" width="120" class="nsf-logo">
        <nav class ="tm-nav">
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="AboutPage.html">About</a></li>
            <li class="dropdown">
				<a href="javascript:void(0)" class="dropbtn">Research + Projects</a>
    			<div class="dropdown-content">
      				<!-- <a href="#">Link 1</a> -->
      				<a href="DataAnimationPage.html">Data Animation</a>
     				<a href="3DheatmapPage.html">3D Visualization</a>
     				<a href="3DhmTimePage.html">3D Visual Interaction</a>
     				<a href="Google_heatmapPage.html">Data Upload Example</a>
     			</div>
			</li>
            <li><a href="TeamPage.html">Contact Our Team</a></li>
          </ul>
        </nav>
      </div>
    </header>
     <!--   Adding a footer
	<footer class= bm-footer>
		<div class="bm-container">
			<a href="https://www.wpi.edu">
			<img src="WPI_logo.png" alt="WPI logo" width="120" class="wpi-logo">
		</div>
	</footer>
	-->
  <!-- there goes the map -->
	<div id="map-canvas"> </div>

  <!-- the draggable input and display controls -->
	<div id="draggable">
		<div class="project">
<a href="index.html" target="X">SURV</a>  
<!-- Change if you'd like to
<a href="http://www.joyofdata.de/blog/interactive-heatmaps-with-google-maps-api/" target="X">joyofdata.de</a> / 
<a href="https://twitter.com/joyofdata" target="X">@joyofdata</a> -->
</div>
		<input type="file" id="csv-file" name="files"/>
<div class="project" style="margin-top:10px">
(sample file: <a href="Shenzhen_Long_and_Lat.csv" target="X">Shenzhen_Taxi_GPS_Data.csv</a>)
</div>
		<div id="radius-label">radius: 20</div>
		<div id="radius-slider"></div>

		<div id="opacity-label">opacity: 1</div>
		<div id="opacity-slider"></div>

		<div id="max-label"> max: - </div>
		<div id="max-slider"></div>
	</div>
</body>
<!--
https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications
http://www.html5rocks.com/en/tutorials/file/dndfiles/
http://blog.teamtreehouse.com/reading-files-using-the-html5-filereader-api
-->
</html>